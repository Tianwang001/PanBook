kind: pipeline
name: default

steps:
- name: build
  image: docker:18.09
  volumes:
  - name: docker_sock
    path: /var/run/docker.sock
  commands:
  - apk add git
  - export TAG=`git describe --tags --exact-match 2> /dev/null || git rev-parse --short HEAD`
  - docker build -t panbook:$TAG .
  - docker tag panbook:$TAG panbook:latest
- name: panbook-doc
  image: panbook:latest
  pull: if-not-exists
  commands:
  - CJK="" DEBUG="-d --trace" make book

volumes:
- name: docker_sock
  host:
    path: /var/run/docker.sock
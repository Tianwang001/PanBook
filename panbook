#!/bin/bash

SCRIPTDIR=`cd $(dirname $0);pwd`
cwd=`pwd`
ofile=`echo $cwd |awk -F '/' '{print $NF}'`

source $SCRIPTDIR/libs/helper.sh
source $SCRIPTDIR/libs/env.sh

getVar SRC "src"
WORKDIR="$cwd/$SRC"
getVar IMGDIR "$WORKDIR/images"
getVar CSL "$SCRIPTDIR/csl/chinese-gb7714-2005-numeric.csl"
getVar BIB "$WORKDIR/bibliography.bib"
BIB_PARAM="--bibliography=$BIB"
DEFAULT_CRS="$SCRIPTDIR/pandoc-crossref-settings.yaml"
getVar CRS "$cwd/pandoc-crossref.yaml"

BUILD="$cwd/build"
HEADERS="$BUILD/add-headers.tex"
METADATA="$WORKDIR/metadata.yaml"
COLUMNS_SUPPORT="--lua-filter $SCRIPTDIR/filters/fenced_divs_columns.lua"
getVar columns "true"

source $SCRIPTDIR/libs/core.sh

# 引入模块
for module in `ls $SCRIPTDIR/libs/module-*`;do
	item=`basename $module`
	source $SCRIPTDIR/libs/$item
done


if [ $# -ge 1 ];then
	[ "$1"x == "-help"x -o "$1"x == "-h"x -o "$1"x == "help"x ] && printhelp
	func=$1
	shift
else
	printhelp
fi

# pandoc 通过 -V 传递给模板的变量
ORIGPANDOCVARS=""

for i in "$@"
do
	key=$1
	case $key in
	-h|--help)
		FUNCHELP=true
		shift;;
	--tpl=*)
		TPL=${key#*=}
		shift;;
	--class=*)
		DOCUMENTCLASS=${key#*=}
		shift;;
	--theme=*)
		THEME=${key#*=}
		shift;;
	--cv=*)
		CV=${key#*=}
		shift;;		
	--css=*)
		CSS=${key#*=}
		shift;;
	--csl=*)
		CSL=${key#*=}
		shift;;
	--crs=*)
		CRS=${key#*=}
		shift;;		
	--bib=*)
		bibtmp=${key#*=}
		BIB_PARAM="$BIB_PARAM --bibliography=$bibtmp"
		shift;;		
	-d|--debug)
		DEBUG=true
		shift;;
	--src=*)
		SRC=${key#*=}
		shift;;
	--imgdir=*)
		IMGDIR=${key#*=}
		shift;;		
	--trace)
		TRACE=true
		shift;;
	-V)
		ORIGPANDOCVARS="$ORIGPANDOCVARS -V $2"
		shift 2;;
	-E)
		eval $2
		shift 2;;
	*);;
	esac
done

note "Welcome to PanBook!"
info "ScriptDir: $SCRIPTDIR"
info "WorkDir: $WORKDIR"
info "ImgDir: $IMGDIR"
info "Function: $func"
info "TPL: $TPL"
info "DOCUMENTCLASS: $DOCUMENTCLASS"
info "THEME: $THEME"
info "DEBUG: $DEBUG"
info "ORIGPANDOCVARS: $ORIGPANDOCVARS"
info "TRACE: $TRACE"

CROSSREF_PARAM="-F pandoc-crossref"
CITEPROC_PARAM="-F pandoc-citeproc $BIB_PARAM --csl=$CSL"
# 由于pandoc-crossref需要使用metadata中的header-includes变量，命令行参数中不能包含 -H，需要使用lua filter将-H参数内容转换为metadata变量
# 参见 https://github.com/annProg/PanBook/issues/8
# -H 参数引入的tex文件，命名为 add-header-*.tex，pandoc执行前，cat add-header-*.tex > add-header.tex
if [ "$func"x == "pdf"x -o "$func"x == "beamer"x ];then
	CROSSREF_PARAM="$CROSSREF_PARAM --lua-filter $SCRIPTDIR/filters/add-header.lua"
fi
PANDOC_REFERENCE_PARAM="$CROSSREF_PARAM $CITEPROC_PARAM"

info "PANDOC_REFERENCE_PARAM: $PANDOC_REFERENCE_PARAM"

if [ "`type -t $func`"x == "function"x ];then
	[ "$TRACE"x == "true"x ] && set -x
	$func
else
	error "Function: $func  not defined"
fi

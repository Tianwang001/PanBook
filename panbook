#!/bin/bash

SCRIPTDIR=`cd $(dirname $0);pwd`
cwd=`pwd`
ofile=`echo $cwd |awk -F '/' '{print $NF}'`

source $SCRIPTDIR/libs/helper.sh
source $SCRIPTDIR/libs/env.sh

getEnv SRC "src"
WORKDIR="$cwd/$SRC"
getEnv IMGDIR "$WORKDIR/images"

BUILD="$cwd/build"
METADATA="$WORKDIR/metadata.yaml"

source $SCRIPTDIR/libs/core.sh

# 引入模块
for module in `ls $SCRIPTDIR/libs/module-*`;do
	item=`basename $module`
	source $SCRIPTDIR/libs/$item
done


if [ $# -ge 1 ];then
	[ "$1"x == "help"x ] && printhelp
	func=$1
	shift
else
	printhelp
fi

# pandoc 通过 -V 传递给模板的变量
PANDOCVARS=""

for i in "$@"
do
	key=$1
	case $key in
	-h|--help)
		FUNCHELP=true
		shift;;
	--tpl=*)
		TPL=${key#*=}
		shift;;
	--class=*)
		DOCUMENTCLASS=${key#*=}
		PANDOCVARS="$PANDOCVARS -V documentclass=$DOCUMENTCLASS"
		shift;;
	--theme=*)
		THEME=${key#*=}
		PANDOCVARS="$PANDOCVARS -V theme=$THEME"
		shift;;
	-d|--debug)
		DEBUG=true
		shift;;
	--trace)
		TRACE=true
		shift;;
	-V)
		PANDOCVARS="$PANDOCVARS -V $2"
		shift 2;;
	*);;
	esac
done

note "Welcome to PanBook!"
info "ScriptDir: $SCRIPTDIR"
info "WorkDir: $WORKDIR"
info "ImgDir: $IMGDIR"
info "Function: $func"
info "TPL: $TPL"
info "DOCUMENTCLASS: $DOCUMENTCLASS"
info "THEME: $THEME"
info "DEBUG: $DEBUG"
info "PANDOCVARS: $PANDOCVARS"
info "TRACE: $TRACE"


if [ "`type -t $func`"x == "function"x ];then
	[ "$TRACE"x == "true"x ] && set -x
	$func
else
	error "Function: $func  not defined"
fi
